#!/usr/bin/env node

/**
 * Sync CLI Templates to Docs App (Enhanced)
 *
 * Features:
 * - Syncs component templates from CLI to docs
 * - Auto-generates componentLoader.ts with imports
 * - Watch mode for live development
 *
 * Usage:
 *   npm run sync:templates        # One-time sync
 *   npm run sync:templates:watch  # Watch mode (for development)
 */

// eslint-disable-next-line @typescript-eslint/no-require-imports
const fs = require("fs");
// eslint-disable-next-line @typescript-eslint/no-require-imports
const path = require("path");

const TEMPLATES_SOURCE = path.join(__dirname, "../../../packages/inam-ui-cli/src/templates");
const TEMPLATES_DEST = path.join(__dirname, "../components/ui");
const LOADER_FILE = path.join(__dirname, "../components/pages/component-docs/componentLoader.ts");

const WATCH_MODE = process.argv.includes("--watch");

// Ensure destination directory exists
if (!fs.existsSync(TEMPLATES_DEST)) {
  fs.mkdirSync(TEMPLATES_DEST, { recursive: true });
}

function getComponentName(filename) {
  // Remove .tsx extension
  return filename.replace(".tsx", "");
}

function getSlugFromComponentName(componentName) {
  // Convert PascalCase to lowercase slug
  // Button -> button, MyComponent -> mycomponent
  return componentName.toLowerCase();
}

function syncTemplates() {
  console.log("ğŸ”„ Syncing component templates...\n");

  // Get all .tsx files from templates
  const templateFiles = fs.readdirSync(TEMPLATES_SOURCE).filter((file) => file.endsWith(".tsx"));

  let syncedCount = 0;
  const components = [];

  templateFiles.forEach((file) => {
    const sourcePath = path.join(TEMPLATES_SOURCE, file);
    const destPath = path.join(TEMPLATES_DEST, file);
    const componentName = getComponentName(file);

    try {
      // Read source file
      const content = fs.readFileSync(sourcePath, "utf8");

      // Add auto-sync comment
      const syncedContent = `// Auto-synced from CLI templates - DO NOT EDIT DIRECTLY
// Edit: packages/inam-ui-cli/src/templates/${file}
// Then run: npm run sync:templates

${content}`;

      // Write to destination
      fs.writeFileSync(destPath, syncedContent, "utf8");

      console.log(`âœ… Synced: ${file}`);
      syncedCount++;

      // Track for loader generation
      components.push({
        name: componentName,
        slug: getSlugFromComponentName(componentName),
        file: file,
      });
    } catch (error) {
      console.error(`âŒ Failed to sync ${file}:`, error.message);
    }
  });

  console.log(`\nâœ¨ Synced ${syncedCount} component(s)\n`);

  // Auto-generate componentLoader.ts
  generateComponentLoader(components);
}

function generateComponentLoader(components) {
  console.log("ğŸ”§ Auto-generating componentLoader.ts...\n");

  // Sort components alphabetically for consistent output
  components.sort((a, b) => a.name.localeCompare(b.name));

  // Generate imports
  const imports = components
    .map((c) => `import { ${c.name} } from "../../ui/${c.name}";`)
    .join("\n");

  // Generate component map entries
  const mapEntries = components.map((c) => `  ${c.slug}: ${c.name},`).join("\n");

  // Full file content
  const loaderContent = `// Auto-generated by sync-templates.js - DO NOT EDIT MANUALLY
// This file is regenerated every time you run: npm run sync:templates
// To add a new component, just add it to CLI templates and re-sync

${imports}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export const componentMap: Record<string, React.ComponentType<any>> = {
${mapEntries}
};

// eslint-disable-next-line @typescript-eslint/no-explicit-any
export function getComponent(slug: string): React.ComponentType<any> | null {
  return componentMap[slug] || null;
}
`;

  fs.writeFileSync(LOADER_FILE, loaderContent, "utf8");
  console.log("âœ… Generated componentLoader.ts with all imports\n");
}

// Watch mode
if (WATCH_MODE) {
  console.log("ğŸ‘€ Watch mode enabled - monitoring for changes...\n");
  console.log(`Watching: ${TEMPLATES_SOURCE}`);
  console.log("Press Ctrl+C to stop\n");

  // Initial sync
  syncTemplates();

  // Watch for changes
  fs.watch(TEMPLATES_SOURCE, { recursive: false }, (eventType, filename) => {
    if (filename && filename.endsWith(".tsx")) {
      console.log(`\nğŸ“ Detected change: ${filename}`);
      syncTemplates();
    }
  });
} else {
  // One-time sync
  syncTemplates();
  console.log('ğŸ’¡ Tip: Use "npm run sync:templates:watch" for live development\n');
}
