# ============================================================
# RELEASE WORKFLOW - Smart Monorepo Release with Trusted Publishing
# ============================================================
# 
# SECURITY FEATURES:
# - Manual trigger only (workflow_dispatch) - no automated releases
# - Protected 'production' environment requires YOUR approval
# - Trusted Publishing via OIDC (no NPM_TOKEN secrets)
# - Change detection prevents unnecessary publishes
#
# HOW TO USE:
# 1. Go to Actions > Release > Run workflow
# 2. Select version bump type (patch/minor/major)
# 3. Approve the deployment when prompted
# 4. Done! Package is versioned, tagged, and published
# ============================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version Bump Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      force_publish:
        description: 'Force publish even if no CLI changes detected'
        required: false
        default: false
        type: boolean

# Security: Minimal permissions, expanded only where needed
permissions:
  contents: read

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================
  # Step 1: Detect what actually changed
  # ============================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cli_changed: ${{ steps.changes.outputs.cli }}
      docs_changed: ${{ steps.changes.outputs.docs }}
      should_publish: ${{ steps.decision.outputs.should_publish }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Check for CLI changes since last tag
        id: changes
        run: |
          # Get the last release tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found, assuming all changed"
            echo "cli=true" >> $GITHUB_OUTPUT
            echo "docs=true" >> $GITHUB_OUTPUT
          else
            echo "Comparing against $LAST_TAG"
            
            # Check if CLI files changed
            if git diff --name-only $LAST_TAG HEAD | grep -q "^packages/inam-ui-cli/"; then
              echo "cli=true" >> $GITHUB_OUTPUT
              echo "âœ… CLI changes detected"
            else
              echo "cli=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No CLI changes"
            fi
            
            # Check if Docs files changed
            if git diff --name-only $LAST_TAG HEAD | grep -q "^apps/docs/"; then
              echo "docs=true" >> $GITHUB_OUTPUT
              echo "âœ… Docs changes detected"
            else
              echo "docs=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No Docs changes"
            fi
          fi

      - name: Decide if we should publish
        id: decision
        run: |
          if [ "${{ inputs.force_publish }}" == "true" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ Force publish enabled"
          elif [ "${{ steps.changes.outputs.cli }}" == "true" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Will publish - CLI changes detected"
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping publish - no CLI changes"
          fi

  # ============================================
  # Step 2: Publish to npm (only if CLI changed)
  # ============================================
  publish:
    name: ðŸ“¦ Publish to npm
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_publish == 'true'
    
    # SECURITY: Protected environment requires YOUR approval
    environment: production
    
    # SECURITY: Expanded permissions only for this job
    permissions:
      contents: write      # Push version commits and tags
      id-token: write      # OIDC for npm Trusted Publishing

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Dependencies
        run: npm ci

      - name: Build CLI
        run: npm run build:cli

      - name: Run Tests
        run: |
          cd packages/inam-ui-cli
          npm test

      - name: Bump Version
        id: version
        run: |
          cd packages/inam-ui-cli
          
          # Get current version before bump
          OLD_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $OLD_VERSION"
          
          # Bump version (no git tag yet, we'll do it manually)
          npm version ${{ inputs.version_bump }} --no-git-tag-version
          
          # Get new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version already exists on npm
        id: check
        run: |
          PACKAGE_NAME=$(node -p "require('./packages/inam-ui-cli/package.json').name")
          VERSION="${{ steps.version.outputs.version }}"
          
          if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null; then
            echo "âŒ Version $VERSION already exists on npm!"
            echo "exists=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… Version $VERSION is available"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit Version Bump
        run: |
          git add packages/inam-ui-cli/package.json
          git commit -m "chore(release): v${{ steps.version.outputs.version }}"

      - name: Create Git Tag
        run: |
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"

      - name: Push Changes
        run: |
          git push origin HEAD
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Publish to npm (Trusted Publishing)
        run: |
          cd packages/inam-ui-cli
          npm publish --provenance --access public
        # NOTE: No NODE_AUTH_TOKEN needed! OIDC handles authentication.

      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Install:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "npx inam-ui@${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Step 3: Skip notification (when no CLI changes)
  # ============================================
  skip-publish:
    name: â­ï¸ Skip Publish
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.should_publish == 'false'
    
    steps:
      - name: Notify Skip
        run: |
          echo "## â­ï¸ Publish Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected in \`packages/inam-ui-cli/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If you want to force a release anyway, re-run with **Force publish** enabled." >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.docs_changed }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Docs changes detected** - Vercel will deploy automatically." >> $GITHUB_STEP_SUMMARY
          fi
